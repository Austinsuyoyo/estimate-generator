<!DOCTYPE html>
<html lang="zh-TW">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>報價單產生器</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
      :root {
        /* 淺色主題（預設） */
        --primary-100:#2e8b57;
        --primary-200:#61bc84;
        --primary-300:#c6ffe6;
        --accent-100:#8fbc8f;
        --accent-200:#345e37;
        --text-100:#333333;
        --text-200:#5c5c5c;
        --bg-100:#FFFFFF;
        --bg-200:#f5f5f5;
        --bg-300:#cccccc;
        --success-200:#4CAF50;
        --bg-400:#444;
      }
      
      [data-theme="dark"] {
        /* 深色主題 */
        --primary-100:#2E8B57;
        --primary-200:#61bc84;
        --primary-300:#c6ffe6;
        --accent-100:#8FBC8F;
        --accent-200:#345e37;
        --text-100:#FFFFFF;
        --text-200:#e0e0e0;
        --bg-100:#1E1E1E;
        --bg-200:#2d2d2d;
        --bg-300:#454545;
      }
      
      /* 套用主題顏色 */
      body {
        background-color: var(--bg-100);
        color: var(--text-100);
        transition: all 0.3s ease;
      }
      
      h1, h2, h3, h4, h5, h6 {
        color: var(--text-100);
      }
      
      hr {
        border-color: var(--bg-300);
      }
      
      .card {
        background-color: var(--bg-200);
        border-color: var(--bg-300);
      }
      
      .card-header {
        background-color: var(--primary-100) !important;
        color: white !important;
        font-weight: bold;
      }
      
      .form-control, .form-select {
        background-color: var(--bg-100);
        color: var(--text-100);
        border-color: var(--bg-300);
      }
      
      .form-control:focus, .form-select:focus {
        background-color: var(--bg-100);
        color: var(--text-100);
        border-color: var(--primary-100);
        box-shadow: 0 0 0 0.25rem rgba(46, 139, 87, 0.25);
      }
      
      .form-control::placeholder {
        color: var(--text-200);
      }
      
      .form-label {
        color: var(--text-100);
        font-weight: 500;
      }
      
      .table {
        color: var(--text-100);
        border-color: var(--bg-300);
      }
      
      .table th {
        background-color: var(--bg-300);
        color: var(--text-100);
        border-color: var(--bg-300);
      }
      
      .table td {
        background-color: var(--bg-200);
        border-color: var(--bg-300);
      }
      
      /* 確保表格標題在深色主題下可見 */
      .table th, .table td {
        color: var(--text-100) !important;
      }
      
      /* 小計、稅金、總計表格樣式 */
      .table-bordered th, .table-bordered td {
        border-color: var(--bg-300) !important;
      }
      
      /* 深色主題下表格標題加強 */
      [data-theme="dark"] .table th {
        background-color: var(--accent-200) !important;
        color: white !important;
        font-weight: bold;
      }
      
      /* 深色主題下表格內容加強 */
      [data-theme="dark"] .table td {
        background-color: var(--bg-200) !important;
      }
      
      /* 小計、稅金、總計行特殊樣式 */
      .table tr.subtotal td, .table tr.tax td, .table tr.total td {
        font-weight: bold !important;
        font-size: 1.05em;
      }
      
      /* 深色主題下小計、稅金、總計行特殊樣式 */
      [data-theme="dark"] .table tr.subtotal td, 
      [data-theme="dark"] .table tr.tax td, 
      [data-theme="dark"] .table tr.total td {
        background-color: var(--accent-100) !important;
        color: white !important;
      }
      
      /* 總計行特別突出 */
      .table tr.total td {
        font-size: 1.1em !important;
        color: var(--primary-100) !important;
      }
      
      [data-theme="dark"] .table tr.total td {
        background-color: var(--primary-100) !important;
        color: white !important;
      }
      
      .modal-content {
        background-color: var(--bg-200);
        color: var(--text-100);
        border-color: var(--bg-300);
      }
      
      .modal-header, .modal-footer {
        border-color: var(--bg-300);
      }
      
      .btn-outline-primary {
        color: var(--primary-100);
        border-color: var(--primary-100);
      }
      
      .btn-outline-primary:hover {
        background-color: var(--primary-100);
        color: white;
      }
      
      .btn-outline-info {
        color: var(--accent-100);
        border-color: var(--accent-100);
      }
      
      .btn-outline-info:hover {
        background-color: var(--accent-100);
        color: white;
      }
      
      .btn-primary {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
      }
      
      .btn-primary:hover {
        background-color: var(--accent-200);
        border-color: var(--accent-200);
      }
      
      .btn-success {
        background-color: var(--primary-200);
        border-color: var(--primary-200);
      }
      
      .btn-success:hover {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
      }
      
      .btn-info {
        background-color: var(--accent-100);
        border-color: var(--accent-100);
      }
      
      .btn-info:hover {
        background-color: var(--accent-200);
        border-color: var(--accent-200);
      }
      
      .btn-secondary {
        background-color: var(--bg-300);
        border-color: var(--bg-300);
        color: var(--text-100);
      }
      
      .btn-secondary:hover {
        background-color: var(--text-200);
        border-color: var(--text-200);
      }
      
      .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
      }
      
      .alert-warning {
        background-color: rgba(255, 193, 7, 0.2);
        color: var(--text-100);
        border-color: rgba(255, 193, 7, 0.5);
      }
      
      /* 主題切換按鈕樣式 */
      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-200);
        color: var(--text-100);
        border: 1px solid var(--bg-300);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
      }
      
      .theme-toggle:hover {
        background-color: var(--bg-300);
        transform: rotate(30deg);
      }
      
      /* 淺色主題下的特殊調整 */
      [data-theme="light"] .btn-add-item {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
        color: white !important;
      }
      
      [data-theme="light"] .btn-add-item:hover {
        background-color: var(--primary-200);
        border-color: var(--primary-200);
        color: white !important;
      }
      
      /* 深色主題下的特殊調整 */
      [data-theme="dark"] .btn-add-item {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
        color: white !important;
      }
      
      [data-theme="dark"] .btn-add-item:hover {
        background-color: var(--primary-200);
        border-color: var(--primary-200);
        color: white !important;
      }
      
      [data-theme="dark"] .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
      }
      
      /* 額外自訂樣式 */
      #submitButton {
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        font-size: 24px;
        z-index: 1000;
      }
      .delete-cell {
        width: 50px;
        text-align: center;
      }
      .card-header {
        font-weight: bold;
      }
      .form-label {
        font-weight: 500;
      }

      
      /* 浮動按鈕樣式 */
      .floating-menu {
        position: fixed;
        bottom: 100px;
        right: 20px;
        z-index: 999;
      }
      .floating-menu .btn-floating {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        background-color: var(--bg-200);
        border: 1px solid var(--bg-300);
      }
      
      /* 特定按鈕樣式 */
      .floating-menu .btn-floating.btn-info {
        background-color: var(--accent-100);
        border-color: var(--accent-100);
        color: white;
      }
      
      .floating-menu .btn-floating.btn-primary {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
        color: white;
      }
      
      .floating-menu .btn-floating.btn-success {
        background-color: var(--success-200);
        border-color: var(--success-200);
        color: white;
      }
      
      .floating-menu .btn-floating:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      
      .floating-menu .btn-floating i {
        font-size: 1.2rem;
      }
      
      /* 移除不必要的按鈕樣式 */
      .floating-menu .btn-floating.btn-info,
      .floating-menu .btn-floating.btn-primary,
      .floating-menu .btn-floating.btn-success {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
        color: white;
      }

      .floating-menu .btn-floating.btn-info:hover,
      .floating-menu .btn-floating.btn-primary:hover,
      .floating-menu .btn-floating.btn-success:hover {
        background-color: var(--primary-200);
        border-color: var(--primary-200);
      }
      
      /* 響應式設計優化 */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        #submitButton {
          bottom: 10px;
          right: 10px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
        .card {
          margin-bottom: 15px;
        }
      }
      /* 表格響應式優化 */
      @media (max-width: 576px) {
        .table-responsive {
          overflow-x: auto;
        }
        .btn-group-sm {
          display: flex;
          flex-wrap: wrap;
        }
        .btn-group-sm .btn {
          margin-bottom: 5px;
        }
      }
      .form-check-input {
        background-color: var(--bg-100);
        border-color: var(--bg-300);
      }
      
      .form-check-input:checked {
        background-color: var(--primary-100);
        border-color: var(--primary-100);
      }
      
      .form-check-label {
        color: var(--text-100);
      }
      
      textarea {
        background-color: var(--bg-100) !important;
        color: var(--text-100) !important;
      }
      
      /* Toast 樣式 */
      .toast {
        background-color: var(--bg-200);
        color: var(--text-100);
        border-color: var(--bg-300);
      }
      
      .toast-body {
        background-color: var(--bg-200);
        color: var(--text-100);
      }
      
      /* 確保按鈕在深色主題下的文字顏色 */
      .btn-primary, .btn-success, .btn-info, .btn-warning {
        color: white !important;
      }
      
      /* 確保按鈕在深色主題下的懸停效果 */
      [data-theme="dark"] .btn-primary:hover {
        background-color: var(--primary-200) !important;
        border-color: var(--primary-200) !important;
      }
      
      [data-theme="dark"] .btn-info:hover {
        background-color: var(--accent-200) !important;
        border-color: var(--accent-200) !important;
      }
      
      [data-theme="dark"] .btn-success:hover {
        background-color: var(--success-200) !important;
        border-color: var(--success-200) !important;
      }
      
      [data-theme="dark"] .btn-secondary:hover {
        background-color: var(--bg-400) !important;
        border-color: var(--bg-400) !important;
      }
    </style>
  </head>

  <body>
    <!-- 主題切換按鈕 -->
    <button class="theme-toggle" id="themeToggle" title="切換深色/淺色主題">
      <i class="bi bi-sun-fill" id="lightIcon"></i>
      <i class="bi bi-moon-fill" id="darkIcon" style="display: none;"></i>
    </button>
    
    <div class="container my-4">
      <h1 class="text-center mb-4">報價單產生器</h1>
      <!-- method="POST" 只是示例，實際動作需搭配後端設定 -->
      <form id="quoteForm" method="POST">
        <div class="row">
          <!-- 左側：基本資料 -->
          <div class="col-lg-6 col-md-12 mb-4">
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">乙方資料（報價方）</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="providerLogo" class="form-label">Logo URL（請注意 CORS 問題）</label>
                    <input type="text" class="form-control" id="providerLogo" name="providerLogo" placeholder="例如：https://example.com/logo.png" value="https://ugc.production.linktr.ee/T2LwXZuRACGuwBNY6jQP_ClMq2eT4AEv08bkc" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="providerName" class="form-label">乙方名稱</label>
                    <input type="text" class="form-control" id="providerName" name="providerName" value="小牛甕烤餅" placeholder="例如：小牛甕烤餅" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="providerPhone" class="form-label">乙方電話</label>
                    <input type="text" class="form-control" id="providerPhone" name="providerPhone" value="0908809853" placeholder="例如：0908809853" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="providerAddress" class="form-label">乙方地址</label>
                    <input type="text" class="form-control" id="providerAddress" name="providerAddress" value="台中市西區自治街153號一樓" placeholder="例如：台中市西區自治街153號一樓" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="providerStaffName" class="form-label">承辦人</label>
                    <input type="text" class="form-control" id="providerStaffName" name="providerStaffName" value="劉懿萱" placeholder="例如：劉懿萱" />
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">客戶資料</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="customerName" class="form-label">客戶名稱</label>
                    <input type="text" class="form-control" id="customerName" name="customerName" placeholder="例如：王小明股份有限公司" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="customerTaxId" class="form-label">客戶統一編號</label>
                    <input type="text" class="form-control" id="customerTaxId" name="customerTaxId" placeholder="例如：12345678" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="customerAddress" class="form-label">客戶地址</label>
                    <input type="text" class="form-control" id="customerAddress" name="customerAddress" placeholder="例如：台北市大同區小明路9號9樓" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="customerPhone" class="form-label">客戶電話</label>
                    <input type="text" class="form-control" id="customerPhone" name="customerPhone" placeholder="例如：02-12345678" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="customerFax" class="form-label">客戶傳真</label>
                    <input type="text" class="form-control" id="customerFax" name="customerFax" placeholder="例如：02-12345678" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="contactName" class="form-label">聯絡人</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="contactName" name="contactName" placeholder="例如：王小明" />
                      <select class="form-select" style="max-width: 100px;" id="contactGender" name="contactGender">
                        <option value="先生">先生</option>
                        <option value="小姐">小姐</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="contactPhone" class="form-label">聯絡人電話</label>
                    <input type="text" class="form-control" id="contactPhone" name="contactPhone" placeholder="例如：0912-345678" />
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">報價單資訊</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="quoteNumber" class="form-label">報價單編號</label>
                    <input type="text" class="form-control" id="quoteNumber" name="quoteNumber" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="quoteDate" class="form-label">報價日期</label>
                    <input type="date" class="form-control" id="quoteDate" name="quoteDate" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="orderType" class="form-label">訂單形式</label>
                    <select class="form-control" id="orderType" name="orderType">
                      <option value="自取">自取</option>
                      <option value="外送">外送</option>
                      <option value="冷凍宅配">冷凍宅配</option>
                      <option value="7-11冷凍店到店">7-11冷凍店到店</option>
                      <option value="全家冷凍店到店">全家冷凍店到店</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryDate" class="form-label">外送日期</label>
                    <input type="date" class="form-control" id="deliveryDate" name="deliveryDate" onchange="updateDeliveryDay()" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryDay" class="form-label">外送星期</label>
                    <input type="text" class="form-control" id="deliveryDay" name="deliveryDay" readonly />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryTime" class="form-label">外送時間</label>
                    <input type="text" class="form-control" id="deliveryTime" name="deliveryTime" placeholder="例如：15:30" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="validDays" class="form-label">報價單有效天數</label>
                    <select class="form-control" id="validDays" name="validDays">
                      <option value="7">7天</option>
                      <option value="14">14天</option>
                      <option value="30">30天</option>
                      <option value="60">60天</option>
                      <option value="90">90天</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryStoreName" class="form-label">外送地點名稱</label>
                    <input type="text" class="form-control" id="deliveryStoreName" name="deliveryStoreName" placeholder="例如：林酒店" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="contactAddresss" class="form-label">外送地址</label>
                    <input type="text" class="form-control" id="contactAddresss" name="contactAddresss" placeholder="例如：台中市西屯區朝富路99號" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="remarks" class="form-label">備註</label>
                    <textarea class="form-control" id="remarks" name="remarks" rows="5">(1)、外送時間:{{deliveryDate}}({{deliveryDay}}){{deliveryTime}}
(2)、外送地址:{{contactAddresss}} - ({{deliveryStoreName}})
(3)、四雨防油紙袋單顆包裝
(4)、訂金為總金額50%，於出貨日三天前付款
(5)、本報價單限報價日期起{{validDays}}天內有效</textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 右側：品項明細與金額 -->
          <div class="col-lg-6 col-md-12">
            <div class="card mb-4">
              <div class="card-header bg-warning">
                <h5 class="mb-0">品項細節</h5>
              </div>
              <div class="card-body">
                <div class="d-flex flex-wrap mb-3">
                  <div class="btn-group-sm mb-2 me-auto">
                    <button type="button" id="addBakeryButton" class="btn btn-primary text-white me-2 mb-1">
                      ＋ 新增烤餅
                    </button>
                    <button type="button" id="addDrinkButton" class="btn btn-info text-white me-2 mb-1">
                      ＋ 新增飲料
                    </button>
                    <button type="button" id="addOtherButton" class="btn btn-secondary me-2 mb-1">
                      ＋ 新增其他
                    </button>
                  </div>
                  <button type="button" id="refreshButton" class="btn btn-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" title="刷新">
                    ↺
                  </button>
                </div>
                <div class="table-responsive">
                  <table class="table table-bordered" id="itemsTable">
                    <thead>
                      <tr>
                        <th style="width: 40%">品名</th>
                        <th style="width: 40%">項目</th>
                        <th style="width: 20%">操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 此處預設不放任何<tr>，直接靠JS動態插入 -->
                    </tbody>
                    <tfoot>
                      <tr class="subtotal">
                        <td colspan="2" class="text-end fw-bold">小計：</td>
                        <td class="fw-bold">$<span id="subtotal">0.00</span></td>
                      </tr>
                      <tr class="tax">
                        <td colspan="2" class="text-end fw-bold">稅金 (5%)：</td>
                        <td class="fw-bold">$<span id="tax">0.00</span></td>
                      </tr>
                      <tr class="total">
                        <td colspan="2" class="text-end fw-bold">總計：</td>
                        <td class="fw-bold">$<span id="total">0.00</span></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
            <!-- 浮動的圓形提交按鈕 -->
            <button type="submit" id="submitButton" class="btn btn-success rounded-circle position-fixed">
              &#10003;
            </button>
          </div>
        </div>
        <div class="col-12 mt-2">
          <!-- 匯入 & 匯出 區塊 -->
          <div class="mb-4 mt-5">
            <hr> <!-- 分隔線，表示這是系統功能 -->
            <h3 class="text-center">系統功能</h3>
            
            <div class="btn-group mb-3 w-100">
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="bi bi-box-arrow-up"></i> 匯出 JSON
              </button>
              <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importModal">
                <i class="bi bi-box-arrow-in-down"></i> 匯入 JSON
              </button>
              <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#localStorageModal">
                <i class="bi bi-database"></i> 本地儲存管理
              </button>
            </div>
          </div>
          <!-- ./ -->
        </div>
      </form>
    </div>

    <!-- 浮動按鈕菜單 -->
    <div class="floating-menu">
      <button type="button" class="btn btn-info btn-floating" data-bs-toggle="modal" data-bs-target="#exportModal" title="匯出 JSON">
        <i class="bi bi-box-arrow-up"></i>
      </button>
      <button type="button" class="btn btn-primary btn-floating" data-bs-toggle="modal" data-bs-target="#importModal" title="匯入 JSON">
        <i class="bi bi-box-arrow-in-down"></i>
      </button>
      <button type="button" class="btn btn-success btn-floating" data-bs-toggle="modal" data-bs-target="#localStorageModal" title="本地儲存管理">
        <i class="bi bi-database"></i>
      </button>
    </div>

    <!-- 匯出 JSON 模態框 -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exportModalLabel">匯出 JSON</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea class="form-control" id="exportedJson" rows="10" readonly></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            <button type="button" class="btn btn-primary" onclick="exportFormData()">
              <i class="bi bi-arrow-clockwise"></i> 更新
            </button>
            <button type="button" class="btn btn-success" onclick="copyExportedJson()">
              <i class="bi bi-clipboard"></i> 複製
            </button>
            <button type="button" class="btn btn-info" onclick="downloadJson()">
              <i class="bi bi-download"></i> 下載
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 匯入 JSON 模態框 -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="importModalLabel">匯入 JSON</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <textarea class="form-control" id="importJson" rows="10" placeholder="請貼上 JSON"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            <button type="button" class="btn btn-primary" onclick="importFormData()">匯入</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 本地儲存管理模態框 -->
    <div class="modal fade" id="localStorageModal" tabindex="-1" aria-labelledby="localStorageModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="localStorageModalLabel">本地儲存管理</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>您的表單數據會自動保存在瀏覽器的本地儲存中。</p>
            <div class="alert alert-warning">
              <strong>注意：</strong> 清除瀏覽器緩存或使用隱私模式可能會導致數據丟失。
            </div>
            
            <div class="mb-4">
              <h5>主題設置</h5>
              <div class="btn-group w-100 mb-3">
                <button type="button" class="btn btn-outline-primary" onclick="setTheme('light')">
                  <i class="bi bi-sun-fill"></i> 淺色主題
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="setTheme('dark')">
                  <i class="bi bi-moon-fill"></i> 深色主題
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="setTheme('auto')">
                  <i class="bi bi-circle-half"></i> 跟隨系統
                </button>
              </div>
            </div>
            
            <h5>數據管理</h5>
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-primary" onclick="saveFormDataToLocalStorage(); showToast('保存成功', '表單數據已手動保存到本地儲存', 'success'); $('#localStorageModal').modal('hide');">
                <i class="bi bi-save"></i> 手動保存當前表單
              </button>
              <button type="button" class="btn btn-danger" onclick="if(confirm('確定要清除本地儲存的表單數據嗎？此操作無法撤銷。')) { clearLocalStorageData(); $('#localStorageModal').modal('hide'); }">
                <i class="bi bi-trash"></i> 清除本地儲存數據
              </button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 通用品項模板 -->
    <script type="text/template" id="itemTemplate">
      <tr class="descRow">
        <td>
          <label class="form-label">品名</label>
          {{typeContent}}
        </td>
        <td>
          <label class="form-label">項目</label>
          {{nameContent}}
        </td>
        <td rowspan="2" class="align-middle text-center">
          <button
            type="button"
            class="btn btn-danger btn-sm"
            onclick="removeRow(this)"
            title="刪除"
          >
            X
          </button>
        </td>
      </tr>
      <tr class="numberRow">
        <td>
          <label class="form-label">數量</label>
          <input
            type="number"
            class="form-control"
            name="item_{{item_id}}_quantity"
            step="1"
            min="1"
            value="{{defaultQty}}"
            required
          />
        </td>
        <td>
          <label class="form-label">單價</label>
          <input
            type="number"
            class="form-control"
            name="item_{{item_id}}_price"
            step="1"
            min="0"
            value="{{defaultPrice}}"
            required
          />
        </td>
      </tr>
    </script>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // 菜單配置
    const MENU_CONFIG = {
      bakery: [
        { value: "蔥油蘿蔔", label: "蔥油蘿蔔", price: 30 },
        { value: "香椿蘿蔔", label: "香椿蘿蔔", price: 30 },
        { value: "黃金糖", label: "黃金糖", price: 30 },
        { value: "紅豆泥", label: "紅豆泥", price: 30 },
        { value: "芋仔泥", label: "芋仔泥", price: 30 },
        { value: "黑芝麻", label: "黑芝麻", price: 30 },
        { value: "綠豆沙", label: "綠豆沙", price: 30 },
      ],
      drink: [
        { value: "豆漿(杯)", label: "豆漿(杯)", price: 15 },
        { value: "豆漿(袋)", label: "豆漿(袋)", price: 45 },
        { value: "黑芝麻堅果飲(袋)", label: "黑芝麻堅果飲(袋)", price: 60 }
      ],
      drinkCustomize: {
        sweetness: [
          { value: "無糖", label: "無糖" },
          { value: "微糖", label: "微糖" },
          { value: "正常糖", label: "正常糖" }
        ],
        temperature: [
          { value: "冰", label: "冰" },
          { value: "熱", label: "熱" }
        ]
      },
      other: [
        { value: "其他項目", label: "其他項目" },
        { value: "服務費", label: "服務費" },
        { value: "運費", label: "運費" },
        { value: "包裝費", label: "包裝費" },
        { value: "折扣", label: "折扣" }
      ]
    };

    // 設定日期預設值：今天
    function setDefaultDates() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      $("#quoteDate").val(`${yyyy}-${mm}-${dd}`);
    }

    // 產生報價單編號
    function generateQuoteNumber() {
      const now = new Date();
      const yy = String(now.getFullYear()).slice(-2);
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      const rand = Math.floor(Math.random() * 10);
      return "EST" + yy + mm + dd + hh + min + rand;
    }

    // 合併後的通用添加項目函數
    function addItem(type) {
      let templateHtml = $("#itemTemplate").html();
      const item_id = Math.random().toString(36).substring(2, 15);
      let typeContent = '', nameContent = '', defaultQty = '1', defaultPrice = '0';
      
      switch(type) {
        case 'bakery':
          typeContent = `<div class="d-flex flex-wrap">
            <div class="form-check me-3 mb-2">
              <input class="form-check-input" type="radio" name="item_${item_id}_type" value="現烤烤餅" id="itemType_${item_id}_1" checked>
              <label class="form-check-label" for="itemType_${item_id}_1">現烤烤餅</label>
            </div>
            <div class="form-check me-3 mb-2">
              <input class="form-check-input" type="radio" name="item_${item_id}_type" value="冷凍烤餅" id="itemType_${item_id}_2">
              <label class="form-check-label" for="itemType_${item_id}_2">冷凍烤餅</label>
            </div>
          </div>`;
          
          let bakeryOptions = MENU_CONFIG.bakery.map(item => 
            `<option value="${item.value}" data-price="${item.price}">${item.label}</option>`
          ).join('');
          
          nameContent = `<select class="form-select" name="item_${item_id}_name" onchange="updateBakeryPrice(this)">
            ${bakeryOptions}
          </select>`;
          defaultPrice = MENU_CONFIG.bakery[0].price.toString();
          break;
          
        case 'drink':
          typeContent = `<input type="hidden" name="item_${item_id}_type" value="飲料">
            <div class="form-control">飲料</div>`;
          
          let drinkOptions = MENU_CONFIG.drink.map(item => 
            `<option value="${item.value}" data-price="${item.price}">${item.label}</option>`
          ).join('');
          
          let sweetnessOptions = MENU_CONFIG.drinkCustomize.sweetness.map(item => 
            `<option value="${item.value}">${item.label}</option>`
          ).join('');
          
          let temperatureOptions = MENU_CONFIG.drinkCustomize.temperature.map(item => 
            `<option value="${item.value}">${item.label}</option>`
          ).join('');
          
          nameContent = `
            <div class="row">
              <div class="col-12 mb-2">
                <select class="form-select" name="item_${item_id}_name" onchange="updateDrinkPrice(this)">
                  ${drinkOptions}
                </select>
              </div>
              <div class="col-6">
                <select class="form-select form-select-sm" name="item_${item_id}_sweetness">
                  <option value="">-- 甜度 --</option>${sweetnessOptions}
                </select>
              </div>
              <div class="col-6">
                <select class="form-select form-select-sm" name="item_${item_id}_temperature">
                  <option value="">-- 溫度 --</option>${temperatureOptions}
                </select>
              </div>
            </div>
            <textarea class="form-control mt-2" name="item_${item_id}_description" placeholder="請輸入其他備註" rows="1"></textarea>`;
          defaultPrice = MENU_CONFIG.drink[0].price.toString();
          break;
          
        case 'other':
          typeContent = `<input type="hidden" name="item_${item_id}_type" value="其他">
            <div class="form-control">其他</div>`;
          
          let otherOptions = MENU_CONFIG.other.map(item => 
            `<option value="${item.value}">${item.label}</option>`
          ).join('');
          
          nameContent = `<select class="form-select" name="item_${item_id}_name">${otherOptions}</select>
            <textarea class="form-control mt-2" name="item_${item_id}_description" placeholder="請輸入描述" rows="1"></textarea>`;
          break;
      }
      
      templateHtml = templateHtml
        .replace(/{{typeContent}}/g, typeContent)
        .replace(/{{nameContent}}/g, nameContent)
        .replace(/{{defaultQty}}/g, defaultQty)
        .replace(/{{defaultPrice}}/g, defaultPrice)
        .replace(/{{item_id}}/g, item_id);
      
      $("#itemsTable tbody").append(templateHtml);
      updateTotals();
      
      // 自動保存
      saveFormDataToLocalStorage();
      
      return item_id;
    }

    // 刪除行
    function removeRow(button) {
      const $btn = $(button);
      const $row = $btn.closest("tr");
      const $relatedRow = $row.hasClass("descRow") ? $row.next() : $row.prev();

      if ($("#itemsTable tbody tr").length > 2) {
        $row.remove();
        $relatedRow.remove();
        updateTotals();
        
        // 自動保存
        saveFormDataToLocalStorage();
      } else {
        alert("至少需保留一個品項");
      }
    }

    // 計算小計、稅金、總計
    function updateTotals() {
      let subtotal = 0;
      $("input[name$='_quantity']").each(function() {
        const qty = parseInt($(this).val()) || 0;
        const name = $(this).attr('name');
        const idMatch = name.match(/item_([a-z0-9]+)_quantity/);
        
        if (idMatch && idMatch[1]) {
          const itemId = idMatch[1];
          const priceInput = $(`input[name="item_${itemId}_price"]`);
          if (priceInput.length) {
            const price = parseInt(priceInput.val()) || 0;
            subtotal += qty * price;
          }
        }
      });

      const taxPercent = parseInt($("#taxPercent").val()) || 0;
      const tax = Math.floor((subtotal * taxPercent) / 100);
      const total = subtotal + tax;

      $("#subtotalDisplay").text(subtotal.toLocaleString());
      $("#taxDisplay").text(tax.toLocaleString());
      $("#totalDisplay").text(total.toLocaleString());
    }

    // 事件處理函數
    function handleBlurSetZero() {
      if ($(this).val().trim() === "") $(this).val("0");
      updateTotals();
    }

    function handleBlurSetOne() {
      if ($(this).val().trim() === "" || $(this).val().trim() === "0") $(this).val("1");
      updateTotals();
    }

    // 根据日期更新星期几
    function updateDeliveryDay() {
      const deliveryDateInput = document.getElementById('deliveryDate');
      const deliveryDayInput = document.getElementById('deliveryDay');
      
      if (deliveryDateInput.value) {
        const date = new Date(deliveryDateInput.value);
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        deliveryDayInput.value = weekdays[date.getDay()];
        updateRemarks();
      } else {
        deliveryDayInput.value = '';
      }
    }

    // 更新備註中的變數
    function updateRemarks() {
      const deliveryDate = $("#deliveryDate").val() || '';
      const deliveryDay = $("#deliveryDay").val() || '';
      const deliveryTime = $("#deliveryTime").val() || '';
      const contactAddresss = $("#contactAddresss").val() || '';
      const deliveryStoreName = $("#deliveryStoreName").val() || '';
      const validDays = $("#validDays").val() || '7';
      
      const currentRemarks = $("#remarks").val();
      const isDefaultFormat = currentRemarks.includes('(1)、外送時間:') && 
                              currentRemarks.includes('(2)、外送地址:') &&
                              currentRemarks.includes('(3)、四雨防油紙袋單顆包裝');
      
      if (isDefaultFormat || currentRemarks.trim() === '') {
        let remarksText = `(1)、外送時間:${deliveryDate}(${deliveryDay})${deliveryTime}
(2)、外送地址:${contactAddresss}(${deliveryStoreName})
(3)、四雨防油紙袋單顆包裝
(4)、訂金為總金額50%，於出貨日三天前付款
(5)、本報價單限報價日期起${validDays}天內有效`;
        
        $("#remarks").val(remarksText);
      }
    }

    // 調整UI以適應不同屏幕尺寸
    function adjustUIForScreenSize() {
      const windowWidth = $(window).width();
      if (windowWidth < 768) $("#itemsTable").addClass("table-sm");
      else $("#itemsTable").removeClass("table-sm");
    }

    // 表單提交前檢查
    function validateForm() {
      if ($("#itemsTable tbody tr").length === 0) {
        alert("請至少添加一個品項");
        return false;
      }
      return true;
    }

    // 定義表單欄位配置
    const FORM_FIELDS = {
      provider: [
        { id: "providerLogo", defaultValue: "https://ugc.production.linktr.ee/T2LwXZuRACGuwBNY6jQP_ClMq2eT4AEv08bkc" },
        { id: "providerName", defaultValue: "小牛甕烤餅" },
        { id: "providerAddress", defaultValue: "台中市西區自治街153號一樓" },
        { id: "providerPhone", defaultValue: "0908809853" },
        { id: "providerStaffName", defaultValue: "劉懿萱" }
      ],
      customer: [
        { id: "customerName", defaultValue: "" }, { id: "customerAddress", defaultValue: "" },
        { id: "customerPhone", defaultValue: "" }, { id: "customerFax", defaultValue: "" },
        { id: "customerTaxId", defaultValue: "" }
      ],
      contact: [
        { id: "contactName", defaultValue: "" }, { id: "contactPhone", defaultValue: "" },
        { id: "contactGender", defaultValue: "先生" }, { id: "contactAddresss", defaultValue: "" }
      ],
      quote: [
        { id: "orderType", defaultValue: "外送" }, { id: "quoteNumber", defaultValue: "" },
        { id: "quoteDate", defaultValue: "" }, { id: "deadline", defaultValue: "" },
        { id: "deliveryDate", defaultValue: "" }, { id: "deliveryDay", defaultValue: "" },
        { id: "deliveryTime", defaultValue: "" }, { id: "deliveryStoreName", defaultValue: "" },
        { id: "taxPercent", defaultValue: "0" }, { id: "remarks", defaultValue: "" },
        { id: "validDays", defaultValue: "7" }
      ]
    };

    // 獲取所有表單欄位的平面列表
    function getAllFormFields() {
      return Object.values(FORM_FIELDS).flat();
    }

    // 匯出表單數據為 JSON
    function exportFormData() {
      const formData = {};
      getAllFormFields().forEach(field => {
        const elementId = field.id;
        const jsonKey = field.jsonKey || elementId;
        formData[jsonKey] = $(`#${elementId}`).val();
      });
      
      formData.items = [];
      const itemsMap = new Map();
      
      $("[name^='item_']").each(function() {
        const name = $(this).attr('name');
        const value = $(this).val();
        const parts = name.split('_');
        if (parts.length >= 3) {
          const id = parts[1];
          const fieldName = parts.slice(2).join('_');
          if (!itemsMap.has(id)) itemsMap.set(id, {});
          itemsMap.get(id)[fieldName] = value;
        }
      });
      
      for (const [id, item] of itemsMap) {
        const type = item.type || '現烤烤餅';
        const name = item.name || '';
        const desc = item.description || '';
        const qty = parseInt(item.quantity, 10) || 0;
        const price = parseInt(item.price, 10) || 0;
        
        const itemObj = { type, name, desc, qty, price };
        if (type === '飲料') {
          itemObj.customOptions = {
            sweetness: item.sweetness || '',
            temperature: item.temperature || ''
          };
        }
        formData.items.push(itemObj);
      }

      $("#exportedJson").val(JSON.stringify(formData, null, 2));
      
      // 保存到 localStorage
      saveFormDataToLocalStorage(formData);
      
      return formData;
    }

    // 複製 JSON 到剪貼簿
    function copyExportedJson() {
      const jsonText = $("#exportedJson").val();
      if (!jsonText) {
        alert("請先點擊『更新』按鈕產生 JSON");
        return;
      }
      
      // 使用現代的 Clipboard API
      if (navigator.clipboard) {
        navigator.clipboard.writeText(jsonText)
          .then(() => {
            // 顯示成功提示
            const copyBtn = $('#exportModal').find('button:contains("複製")');
            const originalText = copyBtn.html();
            copyBtn.html('<i class="bi bi-check-lg"></i> 已複製');
            setTimeout(() => {
              copyBtn.html(originalText);
            }, 2000);
          })
          .catch(err => {
            console.error('複製失敗:', err);
            alert("複製失敗，請手動選取並複製");
          });
      } else {
        // 備用方法
        const exportedJson = document.getElementById("exportedJson");
        exportedJson.select();
        document.execCommand("copy");
        alert("JSON 已複製");
      }
    }

    // 匯入 JSON 到表單
    function importFormData() {
      const jsonText = $("#importJson").val();
      if (!jsonText || jsonText.trim() === '') {
        alert("請先貼上 JSON 數據");
        return;
      }
      
      try {
        const data = JSON.parse(jsonText);
        performLocalImport(data);
        
        // 關閉模態框
        $('#importModal').modal('hide');
        
        // 顯示成功提示
        showToast('匯入成功', '表單數據已成功匯入', 'success');
      } catch (error) {
        console.error('JSON 解析錯誤:', error);
        alert("JSON 格式錯誤，請確認格式是否正確");
      }
    }

    // 本地匯入 JSON 數據
    function performLocalImport(data) {
      try {
        getAllFormFields().forEach(field => {
          const elementId = field.id;
          const jsonKey = field.jsonKey || elementId;
          if (data[jsonKey] !== undefined) $(`#${elementId}`).val(data[jsonKey]);
        });
        
        $("#itemsTable tbody").empty();

        if (data.items && Array.isArray(data.items)) {
          data.items.forEach(function(item) {
            let itemType = 'other';
            if (item.type && item.type.includes('烤餅')) itemType = 'bakery';
            else if (item.type && item.type.includes('飲料')) itemType = 'drink';
            
            const item_id = addItem(itemType);
            const $descRow = $("#itemsTable tbody tr.descRow").last();
            const $numberRow = $descRow.next(".numberRow");
            
            if (itemType === 'bakery') {
              if (item.type === '冷凍烤餅') {
                $descRow.find(`input[name="item_${item_id}_type"][value="冷凍烤餅"]`).prop('checked', true);
              } else {
                $descRow.find(`input[name="item_${item_id}_type"][value="現烤烤餅"]`).prop('checked', true);
              }
            } else {
              const typeInput = $descRow.find(`input[name="item_${item_id}_type"]`);
              if (typeInput.length) {
                typeInput.val(item.type || (itemType === 'drink' ? '飲料' : '其他'));
              }
            }
            
            const nameSelect = $descRow.find(`select[name="item_${item_id}_name"]`);
            if (nameSelect.length && item.name) {
              if (nameSelect.find(`option[value="${item.name}"]`).length) {
                nameSelect.val(item.name);
              } else {
                nameSelect.append(new Option(item.name, item.name));
                nameSelect.val(item.name);
              }
            }
            
            if (itemType === 'drink' && item.customOptions) {
              if (item.customOptions.sweetness) {
                const sweetnessSelect = $descRow.find(`select[name="item_${item_id}_sweetness"]`);
                if (sweetnessSelect.length) {
                  if (sweetnessSelect.find(`option[value="${item.customOptions.sweetness}"]`).length) {
                    sweetnessSelect.val(item.customOptions.sweetness);
                  } else {
                    sweetnessSelect.append(new Option(item.customOptions.sweetness, item.customOptions.sweetness));
                    sweetnessSelect.val(item.customOptions.sweetness);
                  }
                }
              }
              
              if (item.customOptions.temperature) {
                const temperatureSelect = $descRow.find(`select[name="item_${item_id}_temperature"]`);
                if (temperatureSelect.length) {
                  if (temperatureSelect.find(`option[value="${item.customOptions.temperature}"]`).length) {
                    temperatureSelect.val(item.customOptions.temperature);
                  } else {
                    temperatureSelect.append(new Option(item.customOptions.temperature, item.customOptions.temperature));
                    temperatureSelect.val(item.customOptions.temperature);
                  }
                }
              }
            }
            
            const descTextarea = $descRow.find(`textarea[name="item_${item_id}_description"]`);
            if (descTextarea.length && item.desc) descTextarea.val(item.desc);
            
            $numberRow.find(`input[name="item_${item_id}_quantity"]`).val(item.qty || 0);
            $numberRow.find(`input[name="item_${item_id}_price"]`).val(item.price || 0);
          });
        }

        if (data.deliveryDate) updateDeliveryDay();
        updateTotals();
        
        // 保存到 localStorage
        saveFormDataToLocalStorage(data);
      } catch (error) {
        console.error("本地匯入錯誤:", error);
        showToast('匯入失敗', `匯入過程中發生錯誤: ${error.message}`, 'error');
      }
    }

    // 下載 JSON 檔案
    function downloadJson() {
      const jsonText = $("#exportedJson").val();
      if (!jsonText) {
        alert("請先點擊『匯出』按鈕產生 JSON");
        return;
      }

      const blob = new Blob([jsonText], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `報價單資料＿${new Date().toISOString().replace(/[:.]/g, "_")}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // 根據選擇的烤餅口味更新價格
    function updateBakeryPrice(selectElement) {
      const selectedFlavor = $(selectElement).val();
      const name = $(selectElement).attr('name');
      const idMatch = name.match(/item_([a-z0-9]+)_name/);
      
      if (idMatch && idMatch[1]) {
        const itemId = idMatch[1];
        const priceInput = $(`input[name="item_${itemId}_price"]`);
        const bakeryItem = MENU_CONFIG.bakery.find(item => item.value === selectedFlavor);
        if (bakeryItem && priceInput.length) priceInput.val(bakeryItem.price);
      }
      updateTotals();
    }

    // 根據選擇的飲料類型更新價格
    function updateDrinkPrice(selectElement) {
      const selectedDrink = $(selectElement).val();
      const name = $(selectElement).attr('name');
      const idMatch = name.match(/item_([a-z0-9]+)_name/);
      
      if (idMatch && idMatch[1]) {
        const itemId = idMatch[1];
        const priceInput = $(`input[name="item_${itemId}_price"]`);
        const drinkItem = MENU_CONFIG.drink.find(item => item.value === selectedDrink);
        if (drinkItem && priceInput.length) priceInput.val(drinkItem.price);
      }
      updateTotals();
    }

    // 保存表單數據到 localStorage
    function saveFormDataToLocalStorage(formData = null) {
      try {
        if (!formData) {
          formData = exportFormData();
        }
        localStorage.setItem('estimateFormData', JSON.stringify(formData));
        console.log('表單數據已保存到本地儲存');
      } catch (error) {
        console.error('保存表單數據到本地儲存時出錯:', error);
        showToast('保存失敗', `保存到本地儲存時出錯: ${error.message}`, 'error');
      }
    }

    // 從 localStorage 加載表單數據
    function loadFormDataFromLocalStorage() {
      try {
        const savedData = localStorage.getItem('estimateFormData');
        if (savedData) {
          const formData = JSON.parse(savedData);
          performLocalImport(formData);
          console.log('從本地儲存加載表單數據成功');
          
          // 顯示通知
          showLocalStorageNotification();
        }
      } catch (error) {
        console.error('從本地儲存加載表單數據時出錯:', error);
        showToast('加載失敗', `從本地儲存加載數據時出錯: ${error.message}`, 'error');
      }
    }

    // 顯示本地儲存通知
    function showLocalStorageNotification() {
      // 檢查是否已經顯示過通知
      if (localStorage.getItem('localStorageNotificationShown')) {
        return;
      }
      
      // 創建通知元素
      const notification = $(`
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-info text-white">
              <strong class="me-auto">自動保存功能</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              <p>您的表單數據會自動保存在瀏覽器中。</p>
              <p>您可以通過「本地儲存管理」按鈕管理保存的數據。</p>
              <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#localStorageModal">
                查看詳情
              </button>
            </div>
          </div>
        </div>
      `);
      
      // 添加到頁面
      $('body').append(notification);
      
      // 顯示通知
      const toast = new bootstrap.Toast(notification.find('.toast'), {
        autohide: true,
        delay: 5000
      });
      toast.show();
      
      // 標記已顯示通知
      localStorage.setItem('localStorageNotificationShown', 'true');
    }

    // 清除 localStorage 中的表單數據
    function clearLocalStorageData() {
      try {
        localStorage.removeItem('estimateFormData');
        showToast('清除成功', '本地儲存的表單數據已清除', 'success');
        setTimeout(() => {
          location.reload();
        }, 1500);
      } catch (error) {
        console.error('清除本地儲存的表單數據時出錯:', error);
        showToast('清除失敗', `清除本地儲存數據時出錯: ${error.message}`, 'error');
      }
    }

    // 顯示通用 Toast 提示
    function showToast(title, message, type = 'info') {
      // 移除舊的 toast 容器
      $('.toast-container').remove();
      
      // 根據類型設置樣式
      let bgClass = 'bg-info';
      if (type === 'success') bgClass = 'bg-success';
      else if (type === 'warning') bgClass = 'bg-warning';
      else if (type === 'error') bgClass = 'bg-danger';
      
      // 創建通知元素
      const notification = $(`
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
          <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white">
              <strong class="me-auto">${title}</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
              ${message}
            </div>
          </div>
        </div>
      `);
      
      // 添加到頁面
      $('body').append(notification);
      
      // 顯示通知
      const toast = new bootstrap.Toast(notification.find('.toast'), {
        autohide: true,
        delay: 3000
      });
      toast.show();
    }

    // 主題切換功能
    function initTheme() {
      // 檢查本地儲存中是否有主題設置
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light' || savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
      } else if (savedTheme === 'auto' || !savedTheme) {
        // 檢查系統偏好
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        if (prefersDarkScheme.matches) {
          document.documentElement.setAttribute('data-theme', 'dark');
          updateThemeIcon('dark');
        } else {
          document.documentElement.setAttribute('data-theme', 'light');
          updateThemeIcon('light');
        }
        
        // 監聽系統主題變化
        prefersDarkScheme.addEventListener('change', (e) => {
          if (localStorage.getItem('theme') === 'auto' || !localStorage.getItem('theme')) {
            const newTheme = e.matches ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            updateThemeIcon(newTheme);
          }
        });
        
        if (!savedTheme) {
          localStorage.setItem('theme', 'auto');
        }
      }
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
      
      // 顯示主題切換提示
      const themeName = newTheme === 'light' ? '淺色' : '深色';
      showToast('主題已切換', `已切換至${themeName}主題`, 'info');
    }
    
    function setTheme(theme) {
      if (theme === 'auto') {
        localStorage.setItem('theme', 'auto');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const systemTheme = prefersDarkScheme.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', systemTheme);
        updateThemeIcon(systemTheme);
        showToast('主題已設置', '已設置為跟隨系統主題', 'info');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        updateThemeIcon(theme);
        const themeName = theme === 'light' ? '淺色' : '深色';
        showToast('主題已設置', `已設置為${themeName}主題`, 'info');
      }
      
      // 關閉模態框
      $('#localStorageModal').modal('hide');
    }

    function updateThemeIcon(theme) {
      const lightIcon = document.getElementById('lightIcon');
      const darkIcon = document.getElementById('darkIcon');
      
      if (theme === 'dark') {
        lightIcon.style.display = 'none';
        darkIcon.style.display = 'inline-block';
      } else {
        lightIcon.style.display = 'inline-block';
        darkIcon.style.display = 'none';
      }
    }

    $(document).ready(function() {
      // 初始化設定
      setDefaultDates();
      $("#quoteNumber").val(generateQuoteNumber());
      
      // 初始化主題
      initTheme();
      
      // 主題切換按鈕事件
      $("#themeToggle").click(toggleTheme);
      
      // 初始化 tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      
      // 按鈕事件綁定
      $("#addBakeryButton").click(() => addItem('bakery'));
      $("#addDrinkButton").click(() => addItem('drink'));
      $("#addOtherButton").click(() => addItem('other'));
      $("#refreshButton").click(updateTotals);
      
      // 事件監聽
      $(document)
        .on("input", "input[name$='_quantity'], input[name$='_price'], #taxPercent", function() {
          updateTotals();
          // 添加防抖動自動保存
          clearTimeout(window.autoSaveTimeout);
          window.autoSaveTimeout = setTimeout(function() {
            saveFormDataToLocalStorage();
          }, 1000); // 1秒後自動保存
        })
        .on("blur", "input[name$='_quantity']", handleBlurSetOne)
        .on("blur", "input[name$='_price']", handleBlurSetZero);
      
      // 監聽所有表單輸入變更，自動保存
      $("input, select, textarea").on("change", function() {
        clearTimeout(window.autoSaveTimeout);
        window.autoSaveTimeout = setTimeout(function() {
          saveFormDataToLocalStorage();
        }, 1000); // 1秒後自動保存
      });
      
      // 當匯出模態框打開時，自動更新 JSON 數據
      $('#exportModal').on('show.bs.modal', function() {
        exportFormData();
      });
      
      // 外送相關
      $("#deliveryDate").on("change", function() {
        updateDeliveryDay();
        updateRemarks();
      });
      
      $("#deliveryTime, #contactAddresss, #deliveryStoreName, #validDays").on("change", updateRemarks);
      
      // 表單提交
      $("#quoteForm").on("submit", function(e) {
        if (!validateForm()) {
          e.preventDefault();
          return false;
        }
        
        // 保存表單數據到 localStorage
        saveFormDataToLocalStorage();
        
        if ($("input[name='item_quantity']").length > 20) {
          $("<input>").attr({
            type: "hidden",
            name: "hasLargeDataset",
            value: "true"
          }).appendTo($(this));
        }
      });
      
      // UI 調整
      adjustUIForScreenSize();
      $(window).resize(adjustUIForScreenSize);
      
      // 嘗試從 localStorage 加載數據
      loadFormDataFromLocalStorage();
      
      // 如果沒有保存的數據，也顯示通知
      if (!localStorage.getItem('estimateFormData') && !localStorage.getItem('localStorageNotificationShown')) {
        setTimeout(showLocalStorageNotification, 2000);
      }
    });
    </script>
  </body>
</html>
