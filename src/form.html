<!DOCTYPE html>
<html lang="zh-TW">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>報價單產生器</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* 額外自訂樣式 */
      #submitButton {
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        font-size: 24px;
        z-index: 1000;
      }
      .delete-cell {
        width: 50px;
        text-align: center;
      }
      .card-header {
        font-weight: bold;
      }
      .form-label {
        font-weight: 500;
      }
      .table th {
        background-color: #f8f9fa;
      }
      .btn-add-item {
        background-color: #28a745;
        border-color: #28a745;
      }
      .btn-add-item:hover {
        background-color: #218838;
        border-color: #1e7e34;
      }
      /* 響應式設計優化 */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        #submitButton {
          bottom: 10px;
          right: 10px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
        .card {
          margin-bottom: 15px;
        }
      }
      /* 表格響應式優化 */
      @media (max-width: 576px) {
        .table-responsive {
          overflow-x: auto;
        }
        .btn-group-sm {
          display: flex;
          flex-wrap: wrap;
        }
        .btn-group-sm .btn {
          margin-bottom: 5px;
        }
      }
    </style>
  </head>

  <body>
    <div class="container my-4">
      <h1 class="text-center mb-4">報價單產生器</h1>
      <!-- method="POST" 只是示例，實際動作需搭配後端設定 -->
      <form id="quoteForm" method="POST">
        <div class="row">
          <!-- 左側：基本資料 -->
          <div class="col-lg-6 col-md-12 mb-4">
            <div class="card mb-4">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0">乙方資料（報價方）</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="providerLogo" class="form-label">Logo URL（請注意 CORS 問題）</label>
                    <input type="text" class="form-control" id="providerLogo" name="providerLogo" placeholder="例如：https://example.com/logo.png" value="https://ugc.production.linktr.ee/T2LwXZuRACGuwBNY6jQP_ClMq2eT4AEv08bkc" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="providerName" class="form-label">乙方名稱</label>
                    <input type="text" class="form-control" id="providerName" name="providerName" value="小牛甕烤餅" placeholder="例如：小牛甕烤餅" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="providerPhone" class="form-label">乙方電話</label>
                    <input type="text" class="form-control" id="providerPhone" name="providerPhone" value="0908809853" placeholder="例如：0908809853" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="providerAddress" class="form-label">乙方地址</label>
                    <input type="text" class="form-control" id="providerAddress" name="providerAddress" value="台中市西區自治街153號一樓" placeholder="例如：台中市西區自治街153號一樓" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="providerStaffName" class="form-label">承辦人</label>
                    <input type="text" class="form-control" id="providerStaffName" name="providerStaffName" value="劉懿萱" placeholder="例如：劉懿萱" />
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">客戶資料</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="customerName" class="form-label">客戶名稱</label>
                    <input type="text" class="form-control" id="customerName" name="customerName" placeholder="例如：王小明股份有限公司" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="customerTaxId" class="form-label">客戶統一編號</label>
                    <input type="text" class="form-control" id="customerTaxId" name="customerTaxId" placeholder="例如：12345678" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="customerAddress" class="form-label">客戶地址</label>
                    <input type="text" class="form-control" id="customerAddress" name="customerAddress" placeholder="例如：台北市大同區小明路9號9樓" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="customerPhone" class="form-label">客戶電話</label>
                    <input type="text" class="form-control" id="customerPhone" name="customerPhone" placeholder="例如：02-12345678" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="customerFax" class="form-label">客戶傳真</label>
                    <input type="text" class="form-control" id="customerFax" name="customerFax" placeholder="例如：02-12345678" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="contactName" class="form-label">聯絡人</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="contactName" name="contactName" placeholder="例如：王小明" />
                      <select class="form-select" style="max-width: 100px;" id="contactGender" name="contactGender">
                        <option value="先生">先生</option>
                        <option value="小姐">小姐</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="contactPhone" class="form-label">聯絡人電話</label>
                    <input type="text" class="form-control" id="contactPhone" name="contactPhone" placeholder="例如：0912-345678" />
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">報價單資訊</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="quoteNumber" class="form-label">報價單編號</label>
                    <input type="text" class="form-control" id="quoteNumber" name="quoteNumber" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="quoteDate" class="form-label">報價日期</label>
                    <input type="date" class="form-control" id="quoteDate" name="quoteDate" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="orderType" class="form-label">訂單形式</label>
                    <select class="form-control" id="orderType" name="orderType">
                      <option value="自取">自取</option>
                      <option value="外送">外送</option>
                      <option value="冷凍宅配">冷凍宅配</option>
                      <option value="7-11冷凍店到店">7-11冷凍店到店</option>
                      <option value="全家冷凍店到店">全家冷凍店到店</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryDate" class="form-label">外送日期</label>
                    <input type="date" class="form-control" id="deliveryDate" name="deliveryDate" onchange="updateDeliveryDay()" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryDay" class="form-label">外送星期</label>
                    <input type="text" class="form-control" id="deliveryDay" name="deliveryDay" readonly />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryTime" class="form-label">外送時間</label>
                    <input type="text" class="form-control" id="deliveryTime" name="deliveryTime" placeholder="例如：15:30" />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="validDays" class="form-label">報價單有效天數</label>
                    <select class="form-control" id="validDays" name="validDays">
                      <option value="7">7天</option>
                      <option value="14">14天</option>
                      <option value="30">30天</option>
                      <option value="60">60天</option>
                      <option value="90">90天</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="deliveryStoreName" class="form-label">外送地點名稱</label>
                    <input type="text" class="form-control" id="deliveryStoreName" name="deliveryStoreName" placeholder="例如：林酒店" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="contactAddresss" class="form-label">外送地址</label>
                    <input type="text" class="form-control" id="contactAddresss" name="contactAddresss" placeholder="例如：台中市西屯區朝富路99號" />
                  </div>
                  <div class="col-md-12 mb-3">
                    <label for="remarks" class="form-label">備註</label>
                    <textarea class="form-control" id="remarks" name="remarks" rows="5">(1)、外送時間:{{deliveryDate}}({{deliveryDay}}){{deliveryTime}}
(2)、外送地址:{{contactAddresss}} - ({{deliveryStoreName}})
(3)、四雨防油紙袋單顆包裝
(4)、訂金為總金額50%，於出貨日三天前付款
(5)、本報價單限報價日期起{{validDays}}天內有效</textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- 右側：品項明細與金額 -->
          <div class="col-lg-6 col-md-12">
            <div class="card mb-4">
              <div class="card-header bg-warning">
                <h5 class="mb-0">品項細節</h5>
              </div>
              <div class="card-body">
                <div class="d-flex flex-wrap mb-3">
                  <div class="btn-group-sm mb-2 me-auto">
                    <button type="button" id="addBakeryButton" class="btn btn-add-item text-white me-2 mb-1">
                      ＋ 新增烤餅
                    </button>
                    <button type="button" id="addDrinkButton" class="btn btn-info text-white me-2 mb-1">
                      ＋ 新增飲料
                    </button>
                    <button type="button" id="addOtherButton" class="btn btn-secondary me-2 mb-1">
                      ＋ 新增其他
                    </button>
                  </div>
                  <button type="button" id="refreshButton" class="btn btn-secondary d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;" title="刷新">
                    ↺
                  </button>
                </div>
                <div class="table-responsive">
                  <table class="table table-bordered" id="itemsTable">
                    <thead>
                      <tr>
                        <th style="width: 30%">品名</th>
                        <th style="width: 50%">項目</th>
                        <th style="width: 20%">操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- 此處預設不放任何<tr>，直接靠JS動態插入 -->
                    </tbody>
                  </table>
                </div>
                <div class="row mt-3">
                  <div class="col-md-4 mb-3">
                    <label for="taxPercent" class="form-label">稅金百分比 (%)</label>
                    <input type="number" class="form-control" id="taxPercent" name="taxPercent" step="1" min="0" value="0" required />
                  </div>
                  <div class="col-md-8">
                    <!-- Totals 以兩行表格呈現 -->
                    <div class="table-responsive">
                      <table class="table table-bordered text-center">
                        <tr>
                          <th>小計</th>
                          <th>稅金</th>
                          <th>總計</th>
                        </tr>
                        <tr>
                          <td id="subtotalDisplay">0</td>
                          <td id="taxDisplay">0</td>
                          <td id="totalDisplay">0</td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- 浮動的圓形提交按鈕 -->
            <button type="submit" id="submitButton" class="btn btn-success rounded-circle position-fixed">
              &#10003;
            </button>
          </div>
        </div>
        <div class="col-12 mt-2">
          <!-- 匯入 & 匯出 區塊 -->
          <div class="mb-4 mt-5">
            <hr> <!-- 分隔線，表示這是系統功能 -->
            <h3 class="text-center">系統功能</h3>
            <!-- 匯出 JSON -->
            <div class="mb-3">
              <label for="exportedJson" class="form-label">匯出 JSON</label>
              <textarea class="form-control" id="exportedJson" rows="5" readonly></textarea>
              <button type="button" class="btn btn-primary mt-2" onclick="exportFormData()">匯出</button>
              <button type="button" class="btn btn-secondary mt-2" onclick="copyExportedJson()">複製 JSON</button>
              <button type="button" class="btn btn-secondary mt-2" onclick="downloadJson()">下載 JSON</button>
            </div>
            <!-- 匯入 JSON -->
            <div class="mb-3">
              <label for="importJson" class="form-label">匯入 JSON</label>
              <textarea class="form-control" id="importJson" rows="5" placeholder="請貼上 JSON"></textarea>
              <button type="button" class="btn btn-success mt-2" onclick="importFormData()">匯入</button>
            </div>
          </div>
          <!-- ./ -->
        </div>
      </form>
    </div>
    <!-- 通用品項模板 -->
    <script type="text/template" id="itemTemplate">
      <tr class="descRow">
        <td>
          <label class="form-label">品名</label>
          {{typeContent}}
        </td>
        <td>
          <label class="form-label">項目</label>
          {{nameContent}}
        </td>
        <td rowspan="2" class="align-middle text-center">
          <button
            type="button"
            class="btn btn-danger btn-sm"
            onclick="removeRow(this)"
            title="刪除"
          >
            X
          </button>
        </td>
      </tr>
      <tr class="numberRow">
        <td>
          <label class="form-label">數量</label>
          <input
            type="number"
            class="form-control"
            name="itemQuantity"
            step="1"
            min="1"
            value="{{defaultQty}}"
            required
          />
        </td>
        <td>
          <label class="form-label">單價</label>
          <input
            type="number"
            class="form-control"
            name="itemUnitPrice"
            step="1"
            min="0"
            value="{{defaultPrice}}"
            required
          />
        </td>
      </tr>
    </script>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // 設定日期預設值：今天
    function setDefaultDates() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      const todayStr = `${yyyy}-${mm}-${dd}`;
      $("#quoteDate").val(todayStr);
    }

    // 產生報價單編號：格式 EST + (最後兩位年份 + 月日小時分鐘 + 隨機一位數)
    function generateQuoteNumber() {
      const now = new Date();
      const yy = String(now.getFullYear()).slice(-2);
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      const rand = Math.floor(Math.random() * 10); // 隨機一位數
      return "EST" + yy + mm + dd + hh + min + rand;
    }

    // 用於生成唯一索引的計數器
    let itemIndexCounter = 0;

    // 合併後的通用添加項目函數
    function addItem(type) {
      // 取出模板裡的 HTML 字串
      let templateHtml = $("#itemTemplate").html();
      
      // 生成唯一索引 - 使用時間戳加計數器確保唯一性
      const index = Date.now() + '_' + (itemIndexCounter++);
      
      // 根據類型設定不同的內容
      let typeContent = '';
      let nameContent = '';
      let defaultQty = '1';
      let defaultPrice = '0';
      
      switch(type) {
        case 'bakery':
          typeContent = `<div class="d-flex flex-wrap">
            <div class="form-check me-3 mb-2">
              <input class="form-check-input" type="radio" name="itemType_${index}" value="現烤烤餅" id="itemType_${index}_1" checked>
              <label class="form-check-label" for="itemType_${index}_1">現烤烤餅</label>
            </div>
            <div class="form-check me-3 mb-2">
              <input class="form-check-input" type="radio" name="itemType_${index}" value="冷凍烤餅" id="itemType_${index}_2">
              <label class="form-check-label" for="itemType_${index}_2">冷凍烤餅</label>
            </div>
          </div>`;
          
          nameContent = `<select class="form-select" name="itemName">
            <option value="蔥油蘿蔔">蔥油蘿蔔</option>
            <option value="香椿蘿蔔">香椿蘿蔔</option>
            <option value="黃金糖">黃金糖</option>
            <option value="紅豆泥">紅豆泥</option>
            <option value="芝麻">芝麻</option>
            <option value="綠豆沙">綠豆沙</option>
            <option value="芋頭">芋頭</option>
          </select>`;
          defaultPrice = '30';
          break;
          
        case 'drink':
          typeContent = `<input type="hidden" name="itemType_${index}" value="飲料">
            <input type="text" class="form-control" name="itemType_${index}_display" value="飲料" readonly />`;
          
          nameContent = `<input type="text" class="form-control" name="itemName" placeholder="請輸入飲料名稱" value="飲料" />
            <textarea class="form-control mt-2" name="itemDescription" placeholder="請輸入飲料描述" rows="1"></textarea>`;
          defaultPrice = '25';
          break;
          
        case 'other':
          typeContent = `<input type="hidden" name="itemType_${index}" value="其他">
            <input type="text" class="form-control" name="itemType_${index}_display" value="其他" readonly />`;
          
          nameContent = `<input type="text" class="form-control" name="itemName" placeholder="請輸入品名" value="其他項目" />
            <textarea class="form-control mt-2" name="itemDescription" placeholder="請輸入描述" rows="1"></textarea>`;
          break;
      }
      
      // 替換模板中的變數
      templateHtml = templateHtml
        .replace(/{{typeContent}}/g, typeContent)
        .replace(/{{nameContent}}/g, nameContent)
        .replace(/{{defaultQty}}/g, defaultQty)
        .replace(/{{defaultPrice}}/g, defaultPrice);
      
      // 加到表格 <tbody>
      $("#itemsTable tbody").append(templateHtml);
      
      // 新增完後即刻重新計算
      updateTotals();
    }

    // 刪除品項（包含描述那一行 + 數值那一行）
    function removeRow(button) {
      const $btn = $(button);
      // 找到包含按钮的行
      const $row = $btn.closest("tr");
      // 找到相关的另一行（可能在上面或下面）
      const $relatedRow = $row.hasClass("descRow") ? $row.next() : $row.prev();

      // 至少保留一組品項
      if ($("#itemsTable tbody tr").length > 2) {
        $row.remove();
        $relatedRow.remove();
        updateTotals();
      } else {
        alert("至少需保留一個品項");
      }
    }

    // 計算小計、稅金、總計
    function updateTotals() {
      let subtotal = 0;

      $("input[name='itemQuantity']").each(function(index) {
        const qty = parseInt($(this).val()) || 0;
        const price =
          parseInt($("input[name='itemUnitPrice']").eq(index).val()) || 0;
        subtotal += qty * price;
      });

      const taxPercent = parseInt($("#taxPercent").val()) || 0;
      const tax = Math.floor((subtotal * taxPercent) / 100);
      const total = subtotal + tax;

      $("#subtotalDisplay").text(subtotal.toLocaleString());
      $("#taxDisplay").text(tax.toLocaleString());
      $("#totalDisplay").text(total.toLocaleString());
    }

    // 事件：若輸入框 blur 時發現為空，就改成 "0"
    function handleBlurSetZero() {
      if ($(this).val().trim() === "") {
        $(this).val("0");
      }
      updateTotals();
    }

    // 事件：若輸入框 blur 時發現為空，就改成 "1"
    function handleBlurSetOne() {
      if ($(this).val().trim() === "" || $(this).val().trim() === "0") {
        $(this).val("1");
      }
      updateTotals();
    }

    // 根据日期更新星期几
    function updateDeliveryDay() {
      const deliveryDateInput = document.getElementById('deliveryDate');
      const deliveryDayInput = document.getElementById('deliveryDay');
      
      if (deliveryDateInput.value) {
        const date = new Date(deliveryDateInput.value);
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        const weekday = weekdays[date.getDay()];
        deliveryDayInput.value = weekday;
        
        // 更新備註中的變數
        updateRemarks();
      } else {
        deliveryDayInput.value = '';
      }
    }

    // 更新備註中的變數
    function updateRemarks() {
      const deliveryDate = $("#deliveryDate").val() || '';
      const deliveryDay = $("#deliveryDay").val() || '';
      const deliveryTime = $("#deliveryTime").val() || '';
      const contactAddresss = $("#contactAddresss").val() || '';
      const deliveryStoreName = $("#deliveryStoreName").val() || '';
      const validDays = $("#validDays").val() || '7';
      
      // 檢查備註是否為默認格式，如果用戶已修改則不覆蓋
      const currentRemarks = $("#remarks").val();
      const isDefaultFormat = currentRemarks.includes('(1)、外送時間:') && 
                              currentRemarks.includes('(2)、外送地址:') &&
                              currentRemarks.includes('(3)、四雨防油紙袋單顆包裝') &&
                              currentRemarks.includes('(4)、訂金為總金額50%');
      
      // 只有在首次加載或備註為默認格式時才更新
      if (isDefaultFormat || currentRemarks.trim() === '') {
        let remarksText = `(1)、外送時間:${deliveryDate}(${deliveryDay})${deliveryTime}
(2)、外送地址:${contactAddresss}(${deliveryStoreName})
(3)、四雨防油紙袋單顆包裝
(4)、訂金為總金額50%，於出貨日三天前付款
(5)、本報價單限報價日期起${validDays}天內有效`;
        
        $("#remarks").val(remarksText);
      }
    }

    // 調整UI以適應不同屏幕尺寸
    function adjustUIForScreenSize() {
      const windowWidth = $(window).width();
      
      if (windowWidth < 768) {
        // 在小屏幕上調整表格
        $("#itemsTable").addClass("table-sm");
      } else {
        $("#itemsTable").removeClass("table-sm");
      }
    }

    function getDefaultFakeData() {
      return {
        providerLogo: "https://ugc.production.linktr.ee/T2LwXZuRACGuwBNY6jQP_ClMq2eT4AEv08bkc",
        providerName: "小牛甕烤餅",
        providerPhone: "0908809853",
        providerAddress: "台中市西區自治街153號一樓",
        providerStaffName: "劉懿萱",
        customerName: "測試客戶",
        customerTaxId: "12345678",
        customerAddress: "台中市西屯區台灣大道100號",
        customerPhone: "0912345678",
        contactPhone: "0987654321",
        contactName: "王小明",
        contactGender: "先生",
        contactAddresss: "台中市西屯區台灣大道9527號",
        deliveryTime: "15:30",
        deliveryStoreName: "測試大樓",
        taxPercent: "0",
        quoteDate: new Date().toISOString().split('T')[0]
      };
    }

    async function autofillForm() {
      const data = getDefaultFakeData();

      // 使用 Object.entries 簡化表單填充
      Object.entries(data).forEach(([key, value]) => {
        $(`#${key}`).val(value);
      });
      
      // 設定外送日期為當前日期的一個月後
      const today = new Date();
      const oneMonthLater = new Date(today);
      oneMonthLater.setMonth(today.getMonth() + 1);
      const yyyy = oneMonthLater.getFullYear();
      const mm = String(oneMonthLater.getMonth() + 1).padStart(2, "0");
      const dd = String(oneMonthLater.getDate()).padStart(2, "0");
      const oneMonthLaterStr = `${yyyy}-${mm}-${dd}`;
      $("#deliveryDate").val(oneMonthLaterStr);
      $("#orderType").val("外送");

      // 清空現有項目
      $("#itemsTable tbody").empty();

      // 定義所有口味
      const flavors = [
        "蔥油蘿蔔", "香椿蘿蔔", "黃金糖", "紅豆泥", "芝麻", "綠豆沙", "芋頭"
      ];

      // 使用 Promise.all 批量添加項目
      const addItemPromises = [];
      
      // 添加烤餅項目
      flavors.forEach(() => {
        addItemPromises.push(addItemAsync('bakery'));
      });
      
      // 添加飲料和運送費
      addItemPromises.push(addItemAsync('drink'));
      addItemPromises.push(addItemAsync('other'));
      
      // 等待所有項目添加完成
      await Promise.all(addItemPromises);
      
      // 設置項目值
      setTimeout(setupItemValues, 300, flavors);
    }

    // 輔助函數：異步添加項目
    function addItemAsync(type) {
      return new Promise(resolve => {
        setTimeout(() => {
          addItem(type);
          resolve();
        }, 50);
      });
    }

    // 輔助函數：設置項目值
    function setupItemValues(flavors) {
      const $rows = $("#itemsTable tbody tr");
      
      // 設置烤餅項目
      flavors.forEach((flavor, index) => {
        const descRow = $rows[index * 2];
        const numRow = $rows[index * 2 + 1];
        
        // 確保選擇"現烤烤餅"選項
        $(descRow).find('input[name^="itemType_"][value="現烤烤餅"]').prop('checked', true);
        $(descRow).find('select[name="itemName"]').val(flavor);
        $(numRow).find('input[name="itemQuantity"]').val("20");
        $(numRow).find('input[name="itemUnitPrice"]').val("30");
      });

      // 設置飲料項目
      const drinkIndex = flavors.length * 2;
      $($rows[drinkIndex]).find('input[name="itemName"]').val("豆漿");
      $($rows[drinkIndex]).find('textarea').val("微糖去冰");
      $($rows[drinkIndex + 1]).find('input[name="itemQuantity"]').val("30");
      $($rows[drinkIndex + 1]).find('input[name="itemUnitPrice"]').val("25");

      // 設置運送費
      const lastIndex = $rows.length - 2;
      $($rows[lastIndex]).find('input[name="itemName"]').val("運送費");
      $($rows[lastIndex + 1]).find('input[name="itemQuantity"]').val("1");
      $($rows[lastIndex + 1]).find('input[name="itemUnitPrice"]').val("500");

      updateDeliveryDay();
      updateRemarks();
      updateTotals();
    }

    // 表單提交前檢查
    function validateForm() {
      // 檢查是否有項目
      if ($("#itemsTable tbody tr").length === 0) {
        alert("請至少添加一個品項");
        return false;
      }
      
      return true;
    }

    $(document).ready(function() {
      // ===== 1. 初始化設定 =====
      // 設定日期和報價單編號
      setDefaultDates();
      $("#quoteNumber").val(generateQuoteNumber());
      
      // ===== 2. 按鈕事件綁定 =====
      // 使用事件委託處理按鈕點擊
      $("#addBakeryButton").click(() => addItem('bakery'));
      $("#addDrinkButton").click(() => addItem('drink'));
      $("#addOtherButton").click(() => addItem('other'));
      $("#refreshButton").click(updateTotals);
      
      // ===== 3. 事件監聽 =====
      // 使用事件委託處理數量和價格變更
      $(document)
        .on("input", "input[name='itemQuantity'], input[name='itemUnitPrice'], #taxPercent", updateTotals)
        .on("blur", "input[name='itemQuantity']", handleBlurSetOne)
        .on("blur", "input[name='itemUnitPrice']", handleBlurSetZero)
        .on("click", ".btn-danger", function() { removeRow(this); });
      
      // 外送相關 - 合併事件處理
      $("#deliveryDate").on("change", function() {
        updateDeliveryDay();
        updateRemarks();
      });
      
      // 使用事件委託處理備註更新
      $("#deliveryTime, #contactAddresss, #deliveryStoreName, #validDays")
        .on("change", updateRemarks);
      
      // 表單提交
      $("#quoteForm").on("submit", function(e) {
        if (!validateForm()) {
          e.preventDefault();
          return false;
        }
        
        // 大量數據處理
        if ($("input[name='itemQuantity']").length > 20) {
          $("<input>")
            .attr({
              type: "hidden",
              name: "hasLargeDataset",
              value: "true"
            })
            .appendTo($(this));
        }
      });
      
      // ===== 4. 頁面初始化 =====
      // UI 調整
      adjustUIForScreenSize();
      $(window).resize(adjustUIForScreenSize);
      
      // 預設添加項目
      if ($("#itemsTable tbody tr").length === 0) {
        addItem('bakery');
      }
      
      // 開發環境自動填充
      if (window.location.hostname === "localhost" || window.location.hostname.includes("127.0.0.1")) {
        autofillForm();
      }
    });
    </script>
    <script>
    // 定義表單欄位配置
    const FORM_FIELDS = {
      // 乙方資料（報價方）
      provider: [
        { id: "providerLogo", defaultValue: "https://ugc.production.linktr.ee/T2LwXZuRACGuwBNY6jQP_ClMq2eT4AEv08bkc" },
        { id: "providerName", defaultValue: "小牛甕烤餅" },
        { id: "providerAddress", defaultValue: "台中市西區自治街153號一樓" },
        { id: "providerPhone", defaultValue: "0908809853" },
        { id: "providerStaffName", defaultValue: "劉懿萱" }
      ],
      // 客戶資料
      customer: [
        { id: "customerName", defaultValue: "" },
        { id: "customerAddress", defaultValue: "" },
        { id: "customerPhone", defaultValue: "" },
        { id: "customerFax", defaultValue: "" },
        { id: "customerTaxId", defaultValue: "" }
      ],
      // 聯絡人資料
      contact: [
        { id: "contactName", defaultValue: "" },
        { id: "contactPhone", defaultValue: "" },
        { id: "contactGender", defaultValue: "先生" },
        { id: "contactAddresss", defaultValue: "" }
      ],
      // 報價單資訊
      quote: [
        { id: "orderType", defaultValue: "外送" },
        { id: "quoteNumber", defaultValue: "" },
        { id: "quoteDate", defaultValue: "" },
        { id: "deadline", defaultValue: "" },
        { id: "deliveryDate", defaultValue: "" },
        { id: "deliveryDay", defaultValue: "" },
        { id: "deliveryTime", defaultValue: "" },
        { id: "deliveryStoreName", defaultValue: "" },
        { id: "taxPercent", defaultValue: "0" },
        { id: "remarks", defaultValue: "" },
        { id: "validDays", defaultValue: "7" }
      ]
    };

    // 獲取所有表單欄位的平面列表
    function getAllFormFields() {
      return Object.values(FORM_FIELDS).flat();
    }

    // 匯出表單數據為 JSON
    function exportFormData() {
      const formData = {};
      
      // 從配置中獲取所有欄位並填充數據
      getAllFormFields().forEach(field => {
        const elementId = field.id;
        const jsonKey = field.jsonKey || elementId;
        formData[jsonKey] = $(`#${elementId}`).val();
      });
      
      // 添加品項數據
      formData.items = [];
      
      // 取得所有品項資料
      $("#itemsTable tbody tr.descRow").each(function(index) {
        const $descRow = $(this);
        const $numberRow = $descRow.next(".numberRow");
        
        // 獲取項目類型
        let type = '';
        const typeRadio = $descRow.find('input[name^="itemType_"]:checked');
        const typeHidden = $descRow.find('input[name^="itemType_"][type="hidden"]');
        
        if (typeRadio.length) {
          type = typeRadio.val();
        } else if (typeHidden.length) {
          type = typeHidden.val();
        } else {
          // 嘗試從其他元素獲取類型
          const typeDisplayInput = $descRow.find('input[name$="_display"]');
          if (typeDisplayInput.length) {
            type = typeDisplayInput.val();
          }
        }
        
        // 獲取項目名稱
        let name = '';
        const nameInput = $descRow.find('input[name="itemName"]');
        const nameSelect = $descRow.find('select[name="itemName"]');
        
        if (nameInput.length) {
          name = nameInput.val() || '';
        } else if (nameSelect.length) {
          name = nameSelect.val() || '';
        }
        
        // 獲取項目描述
        const desc = $descRow.find('textarea[name="itemDescription"]').val() || '';
        
        // 獲取數量和價格
        const qty = parseInt($numberRow.find('input[name="itemQuantity"]').val(), 10) || 0;
        const price = parseInt($numberRow.find('input[name="itemUnitPrice"]').val(), 10) || 0;

        formData.items.push({ 
          type,
          name, 
          desc, 
          qty, 
          price 
        });
      });

      // 顯示 JSON
      $("#exportedJson").val(JSON.stringify(formData, null, 2));
    }

    // 複製 JSON 到剪貼簿
    function copyExportedJson() {
      const jsonText = $("#exportedJson").val();
      if (!jsonText) {
        alert("請先點擊『匯出』按鈕產生 JSON");
        return;
      }

      const exportedJson = document.getElementById("exportedJson");
      exportedJson.select();
      document.execCommand("copy");
      alert("JSON 已複製");
    }

    // 匯入 JSON 到表單
    function importFormData() {
      const jsonText = $("#importJson").val();

      try {
        const data = JSON.parse(jsonText);

        // 先嘗試通過 API 驗證 JSON 格式
        fetch(window.location.href, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: jsonText
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            // 直接使用本地匯入函數處理數據
            performLocalImport(data);
          } else {
            alert("JSON 格式錯誤：" + (result.message || "請確認格式是否正確"));
          }
        })
        .catch(error => {
          console.error("匯入錯誤:", error);
          // 如果 API 請求失敗，仍然嘗試本地匯入
          performLocalImport(data);
        });
      } catch (error) {
        alert("JSON 格式錯誤，請確認格式是否正確");
      }
    }

    // 本地匯入 JSON 數據（當 API 請求失敗時使用）
    function performLocalImport(data) {
      try {
        // 從配置中獲取所有欄位並填充數據
        getAllFormFields().forEach(field => {
          const elementId = field.id;
          const jsonKey = field.jsonKey || elementId;
          
          // 如果 JSON 中有對應的值，則填入表單
          if (data[jsonKey] !== undefined) {
            $(`#${elementId}`).val(data[jsonKey]);
          }
        });

        // 清空品項
        $("#itemsTable tbody").empty();

        // 依據 JSON 重新新增品項
        if (data.items && Array.isArray(data.items)) {
          // 重置計數器，確保匯入時索引是連續的
          itemIndexCounter = 0;
          
          data.items.forEach(function(item) {
            // 根據項目類型選擇適當的模板
            let itemType = 'other';
            if (item.type && item.type.includes('烤餅')) {
              itemType = 'bakery';
            } else if (item.type && item.type.includes('飲料')) {
              itemType = 'drink';
            }
            
            // 添加項目 - 直接調用 addItem 函數，它會自動生成唯一索引
            addItem(itemType);
            
            // 獲取剛添加的項目行
            const $descRow = $("#itemsTable tbody tr.descRow").last();
            const $numberRow = $descRow.next(".numberRow");
            
            // 設置項目類型
            if (itemType === 'bakery') {
              // 根據 item.type 選擇正確的單選按鈕
              if (item.type === '冷凍烤餅') {
                $descRow.find('input[name^="itemType_"][value="冷凍烤餅"]').prop('checked', true);
              } else {
                $descRow.find('input[name^="itemType_"][value="現烤烤餅"]').prop('checked', true);
              }
            } else {
              const typeInput = $descRow.find('input[name^="itemType_"]');
              if (typeInput.length) {
                typeInput.val(item.type || (itemType === 'drink' ? '飲料' : '其他'));
              }
              
              const typeDisplayInput = $descRow.find('input[name$="_display"]');
              if (typeDisplayInput.length) {
                typeDisplayInput.val(item.type || (itemType === 'drink' ? '飲料' : '其他'));
              }
            }
            
            // 設置項目名稱
            const nameInput = $descRow.find('input[name="itemName"]');
            const nameSelect = $descRow.find('select[name="itemName"]');
            
            if (nameSelect.length && item.name) {
              // 檢查選項是否存在
              if (nameSelect.find(`option[value="${item.name}"]`).length) {
                nameSelect.val(item.name);
              } else {
                // 如果選項不存在，添加新選項
                nameSelect.append(new Option(item.name, item.name));
                nameSelect.val(item.name);
              }
            } else if (nameInput.length && item.name) {
              nameInput.val(item.name);
            }
            
            // 設置項目描述
            const descTextarea = $descRow.find('textarea[name="itemDescription"]');
            if (descTextarea.length && item.desc) {
              descTextarea.val(item.desc);
            }
            
            // 設置數量和價格
            $numberRow.find('input[name="itemQuantity"]').val(item.qty || 0);
            $numberRow.find('input[name="itemUnitPrice"]').val(item.price || 0);
          });
        }

        // 更新外送日期相關欄位
        if (data.deliveryDate) {
          updateDeliveryDay();
        }
        
        // 重新計算總計
        updateTotals();
        alert("JSON 本地匯入成功");
      } catch (error) {
        console.error("本地匯入錯誤:", error);
        alert("JSON 匯入失敗：" + error.message);
      }
    }

    // 下載 JSON 檔案
    function downloadJson() {
      const jsonText = $("#exportedJson").val();
      if (!jsonText) {
        alert("請先點擊『匯出』按鈕產生 JSON");
        return;
      }

      const blob = new Blob([jsonText], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `報價單資料＿${new Date().toISOString().replace(/[:.]/g, "_")}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    </script>
  </body>
</html>
